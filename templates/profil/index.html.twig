{% extends 'base.html.twig' %}

{% block title %}Profil - AquaBiome{% endblock %}

{# On d√©finit le nom et l'ic√¥ne pour le header de base.html.twig #}
{% block page_name %}Profil{% endblock %}
{% block page_icon %}üë§{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/profil.css') }}">
{% endblock %}

{% block body %}
<div class="profil-content">
    
    <div class="profil-label">Profil</div>

    {# Carte d'identit√© utilisateur dynamique #}
    <section class="user-card">
        <div class="avatar-large">
            {% if app.user.avatar %}
                <img src="{{ asset('uploads/avatars/' ~ app.user.avatar) }}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            {% else %}
                üë§
            {% endif %}
        </div>
        
        <div class="user-info">
            {% if app.user %}
                {# Affiche le nom ou le d√©but de l'email #}
                <h2>{{ app.user.nom|default(app.user.email|split('@')[0]) }}</h2>
                
                {# Affiche l'email stock√© en base de donn√©es #}
                <p>{{ app.user.email }}</p>
                
                <a href="{{ path('app_profil_edit') }}" class="btn-edit" title="Modifier mon profil" style="margin-bottom: 15px; font-size: 1rem; width: 40px; height: 40px;">
                    ‚öôÔ∏è
                </a>
                <br>

                {# Lien de d√©connexion officiel de Symfony #}
                <a href="{{ path('app_logout') }}" class="btn-logout">Se D√©connecter</a>
            {% else %}
                {# Cas de secours si le mec arrive √† acc√©der √† la page sans √™tre connect√© #}
                <h2>Utilisateur</h2>
                <p>Veuillez vous connecter</p>
                <a href="{{ path('app_login') }}" class="btn-logout">Connexion</a>
            {% endif %}
        </div>
    </section>

    {# Section Param√®tres / Historique #}
    <section class="settings-section">
        <div class="profil-label">Param√®tres du Profil</div>
        
        <a href="#" class="history-item">
            <span class="icon-history">üîÑ</span>
            {# On peut m√™me personnaliser le texte avec le nom de l'user #}
            Historique de {{ app.user ? (app.user.nom|default(app.user.userIdentifier)) : 'mon compte' }}
        </a>

        <div class="history-list" style="margin-top: 15px;">
            {% if mesures is defined and mesures is not empty %}
                {% for mesure in mesures %}
                    <div class="history-card">
                        <div class="history-header">
                            <div>
                                <span class="history-date">{{ mesure.dateSaisie|date('d/m/Y √† H:i') }}</span>
                                <div class="history-values">
                                    Temp: <strong>{{ mesure.temperature }}¬∞C</strong> | 
                                    pH: <strong>{{ mesure.ph }}</strong> | 
                                    GH: <strong>{{ mesure.gh }}</strong>
                                </div>
                            </div>
                            <a href="{{ path('app_mesure_edit', {id: mesure.id}) }}" class="btn-edit" title="Modifier">
                                ‚úèÔ∏è
                            </a>
                        </div>

                        {# Affichage de l'historique des modifications #}
                        {% if mesure.historiques is not empty %}
                            <div class="history-traces">
                                <span class="trace-label">Historique des changements :</span>
                                <ul class="trace-list">
                                    {% for trace in mesure.historiques %}
                                        <li class="trace-item">
                                            <small style="color: #b2bec3;">{{ trace.dateAction|date('d/m H:i') }}</small>
                                            {% if trace.action == 'CREATION' %}
                                                <span class="badge-action badge-creation">Cr√©ation</span>
                                            {% else %}
                                                <span class="badge-action badge-modification">Correction</span>
                                                <span class="trace-details">{{ trace.details }}</span>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: white;">Aucune activit√© r√©cente.</p>
            {% endif %}
        </div>
    </section>

</div>
{% endblock %}