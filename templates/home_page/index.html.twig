{% extends 'base.html.twig' %}

{% block title %}Accueil - AquaBiome{% endblock %}
{% block page_name %}Accueil{% endblock %}
{% block page_icon %}üè†{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/home.css') }}">
    <style>
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        .chart-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.1rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        /* Assure que le SVG est centr√© et r√©actif */
        svg {
            display: block;
            margin: 0 auto;
            max-width: 100%;
        }
        /* Style pour les messages d'erreur flash */
        .alert-flash {
            background-color: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            border-left: 5px solid #d63031;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
{% endblock %}

{% block body %}
<div class="home-content">
    
    {# --- AFFICHAGE DES ERREURS (Flash Messages) --- #}
    {% for message in app.flashes('error') %}
        <div class="alert-flash">
            ‚ö†Ô∏è {{ message }}
        </div>
    {% endfor %}

    {# Header de bienvenue #}
    <section class="user-welcome">
        <div class="welcome-avatar">üë§</div>
        <p>
            Bienvenue sur votre tableau de bord, 
            <strong>Invit√©</strong>
        </p>
    </section>

    {# Section Alertes et Date de mise √† jour #}
    <section class="alerts-section">
        <div class="alert-card">
            <h3>Derni√®re activit√©</h3>
            <div style="min-height: 40px;">
                {% if mesure is null %}
                    <p style="font-size: 0.9rem; color: #666;">Aucune mesure enregistr√©e en base de donn√©es.</p>
                {% else %}
                    <p style="font-size: 0.9rem; color: #27ae60;">
                        Dernier relev√© le : <strong>{{ mesure.dateSaisie|date('d/m/Y √† H:i') }}</strong>
                    </p>
                {% endif %}
            </div>
        </div>
    </section>

    {# Grille des param√®tres (Chiffres cl√©s) #}
    <section class="stats-grid">
        <div class="stat-card">
            <span class="status-badge">Normal</span>
            <div class="stat-icon" style="color: #ff7675;">¬∞C</div>
            <span class="stat-label">Temp√©rature</span>
            <div class="stat-value">
                {{ (mesure and mesure.temperature is not null) ? mesure.temperature : '--' }}¬∞C
            </div>
            <span class="stat-range">Plage: 22-26¬∞C</span>
        </div>

        <div class="stat-card">
            <span class="status-badge">Normal</span>
            <div class="stat-icon" style="color: #74b9ff;">üß™</div>
            <span class="stat-label">pH</span>
            <div class="stat-value">
                {{ (mesure and mesure.ph is not null) ? mesure.ph : '--' }}
            </div>
            <span class="stat-range">Plage: 6.5-7.5</span>
        </div>

        <div class="stat-card full-width">
            <span class="status-badge">Normal</span>
            <div class="stat-icon" style="color: #00cec9;">üíß</div>
            <span class="stat-label">GH (Duret√© totale)</span>
            <div class="stat-value">
                {{ (mesure and mesure.gh is not null) ? mesure.gh : '--' }} ¬∞dH
            </div>
            <span class="stat-range">Plage: 6-12 ¬∞dH</span>
        </div>
    </section>

    <div class="content-area" style="overflow-y: auto; padding-bottom: 100px;">
    
        <div class="stats-grid">
            <div class="stat-card full-width" style="background: white !important;">
                
                {# Barre d'onglets #}
                <div class="tabs-header" style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="tab-btn active" onclick="openTab(event, 'tab-gh')">GH</button>
                    <button class="tab-btn" onclick="openTab(event, 'tab-ph')">pH / KH</button>
                    <button class="tab-btn" onclick="openTab(event, 'tab-toxic')">Toxines</button>
                </div>
    
                {# Contenu des graphiques uniquement #}
                <div id="tab-gh" class="tab-content active">
                    <div id="chart_gh" style="width: 100%; height: 250px;"></div>
                </div>
    
                <div id="tab-ph" class="tab-content">
                    <div id="chart_ph_kh" style="width: 100%; height: 250px;"></div>
                </div>
    
                <div id="tab-toxic" class="tab-content">
                    <div id="chart_toxic" style="width: 100%; height: 250px;"></div>
                </div>
    
            </div>
        </div>
    </div>

{# CHARGEMENT DES SCRIPTS #}

{# 1. Librairie D3.js #}
<script src="https://d3js.org/d3.v7.min.js"></script>

{# 2. Passage des donn√©es PHP vers JS #}
<script>
    // rawData contient tout l'historique tri√© par date
    const rawData = {{ chartData|raw }};
    console.log("Donn√©es charg√©es :", rawData);
</script>

{# 3. Ton script de dessin (avec param√®tre de version pour √©viter le cache) #}
<script src="{{ asset('js/aquarium_charts.js') }}?v={{ "now"|date('U') }}"></script>

{% endblock %}